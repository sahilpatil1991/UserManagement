<html xmlns:th="http://www.thymeleaf.org" lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>User Management</title>
	<link rel="stylesheet" th:href="@{/css/main.css}" />


	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
		integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

	<!--<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>-->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
	<!--<script src="js/main.js"></script>-->

</head>

<body>
	<nav class="navbar navbar-expand-sm bg-dark navbar-dark">
		<div class="container">
			<a class="navbar-brand col-md-8 col-sm-6" href="#"><strong>User Management Application</strong></a>
		</div>
	</nav>



	<!-- Input Search box. -->
	<section class="container my-5">

		<div class="row d-flex">
			<form class="form-group col-md-8" method="get" th:action="@{/user}">
				<div class="d-flex">

					<!--	<label class="sr-only" for="inlineFormInput">Name</label> -->
					<input required type="text" name="keyword" th:value="${keyword}" class="form-control mb-2 col-xs-4"
						placeholder="Search">


					<button type="submit" class="btn btn-primary mb-2 mx-4">Search</button>

				</div>
			</form>


			<!-- Modal for Adding User -->
			<div id="myModal" class="modal">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header d-flex justify-content-between">
							<h4 id="card-title" class="modal-title">Add User Details</h4>
							<button type="button" class="close btn btn-outline-danger" data-bs-dismiss="modal"
								aria-label="Close">
								<span>&times;</span>
							</button>
						</div>
						<div class="modal-body">
							<form id="form" method="put" class="my-3 mx-3 px-3" onsubmit="return false;">
								<div class="form-group row py-3 d-none" id="id-row">
									<label for="name" class="col-sm-6 col-form-label">Id</label>
									<div class="col-sm-6">
										<input id="userid" type="text" class="form-control" readonly>
									</div>
								</div>
								<div class="form-group row py-3">
									<label for="name" class="col-sm-6 col-form-label">Name</label>
									<div class="col-sm-6">
										<input id="username" type="text" class="form-control" placeholder="Name"
											required>
									</div>
								</div>
								<div class="form-group row py-3">
									<label for="department" class="col-sm-6 col-form-label">Department</label>
									<div class="col-sm-6">
										<input type="text" class="form-control" id="userdepartment" required
											placeholder="Department">
									</div>
								</div>
								<div class="form-group row py-3">
									<label for="profile" class="col-sm-6 col-form-label">Profile</label>
									<div class="col-sm-6">
										<input type="text" class="form-control" id="userprofile" placeholder="Profile"
											required>
									</div>
								</div>
								<div class="form-group row py-3">
									<label for="qualification" class="col-sm-6 col-form-label">Qualification</label>
									<div class="col-sm-6">
										<input type="text" class="form-control" id="userqualification"
											placeholder="Qualification" required>
									</div>
								</div>
								<div class="form-group row py-3">
									<label for="location" class="col-sm-6 col-form-label">Location</label>
									<div class="col-sm-6">
										<input type="text" class="form-control" id="userlocation" placeholder="Location"
											required>
									</div>
								</div>
								<div class="form-group row my-4">
									<div class="mx-5 col-sm-10 d-flex justify-content-end">
										<button onclick="commonHandler()" id="SubmitBtn" type="submit"
											class="btn btn-outline-primary">Add
											User</button>
									</div>
								</div>
							</form>
						</div>
					</div>
				</div>
			</div>
			<div id="btnCon" class="col-md-4">
				<button onclick="addTrigger()" id="addbtnTrigger" class="btn btn-outline-primary flex-end"
					data-bs-toggle="modal" data-bs-target="#myModal">Add
					User</button>
			</div>
		</div>
	</section>

	<!-- Table to render the user list. -->
	<section class="container">
		<div class="table-responsive-md">
			<table class="table table-hover my-5">
				<thead>
					<tr>
						<th>ID</th>
						<th>User Name</th>
						<th>User Department</th>
						<th>User Profile</th>
						<th>User Location</th>
						<th>User Qualification</th>
						<th>Action</th>
					</tr>
				</thead>
				<tbody th:if="${pageList!=null}">
					<tr th:each="user : ${pageList}">
						<td th:id="'userId-' + ${user.userId}" th:text="${user.userId}"></td>
						<td th:text="${user.userName}"></td>
						<td th:text="${user.userDepartment}"></td>
						<td th:text="${user.userProfile}"></td>
						<td th:text="${user.userLocation}"></td>
						<td th:text="${user.userQualification}"></td>
						<td class="d-flex justify-content-around">
							<button th:href="@{getUser/{id}(id=${user.userId})}" data-bs-toggle="modal"
								data-bs-target="#myModal" class="btn btn-outline-primary" type="button"
								th:onclick="'editbtnTrigger(' + ${user.userId} + ')'">Edit</button>
							<a data-toggle="modal" data-target="#deleteModal" class="btn btn-outline-danger deleteBtn"
								th:href="@{/deleteUser/{id}(id=${user.userId})}">Delete</a>
						</td>
					</tr>
				</tbody>
			</table>
		</div>
	</section>

	<section class="container text-center" th:unless="${pageList!=null}">
		<p>There are no Users.</p>
	</section>

	<section class="container">
		<nav aria-label="Page navigation example">
			<ul class="pagination">
				<li class="page-item">
					<a class="page-link" th:href="@{/user(page=${currentPage-1})}" aria-label="Previous"
						th:classappend="${currentPage == 0 ? 'd-none':''}">
						<span aria-hidden="true">&laquo;</span>
						<span class="sr-only">Previous</span>
					</a>
				</li>
				<li class="page-item" th:each="i : ${#numbers.sequence(0, toatalPages - 1)}"
					th:classappend="${currentPage == i ? 'active' : ''}">
					<a class="page-link" th:href="@{/user(page=${i})}" th:text="${i + 1}"></a>
				</li>
				<a class="page-link" th:href="@{/user(page=${currentPage+1})}" aria-label="Next"
					th:classappend="${currentPage == toatalPages-1 ? 'd-none' : ''}">
					<span aria-hidden="true">&raquo;</span>
					<span class="sr-only">Next</span>
				</a>
				</li>
			</ul>
		</nav>
	</section>





	<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
		integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
		crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
		integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
		crossorigin="anonymous"></script>



	<script>


		//To render the data to update page. (Id needed...)
		var editbtnTrigger = (formId) => {
			var title = document.getElementById("card-title");
			title.innerText = "Update User Details."
			var userId = document.getElementById(`userId-${formId}`);
			var userIdValue = userId.innerHTML;
			var userIdInModal = document.getElementById("userid");
			console.log("user id is :: ", userIdValue);
			var userName = document.getElementById("username");
			var userDepartment = document.getElementById("userdepartment");
			var userProfile = document.getElementById("userprofile");
			var userQualification = document.getElementById("userqualification");
			var userLocation = document.getElementById("userlocation");
			var submitBtn = document.getElementById("SubmitBtn");
			submitBtn.innerHTML = "Update User."
			$.ajax({
				type: "GET",
				contentType: "application/json",
				url: "/getUser",
				data: {id: userIdValue},
				success: function (response) {
					console.log(response);
					userName.value = response.userName;
					userDepartment.value = response.userDepartment;
					userIdInModal.value = response.userId;
					userQualification.value = response.userQualification;
					userLocation.value = response.userLocation;
					userProfile.value = response.userProfile;

				},
				error: function (error) {
					console.log(error);
				}
			})
		}


		//To actually update the data.
		var update = () => {
			var userId = document.getElementById("userid");

			var IdValue = userId.value;
			console.log("user id is :: ", userId);
			console.log("user value is:: ", IdValue);
			var userIdValue = parseInt(IdValue);
			var Name = document.getElementById("username").value;
			var userName = String(Name);
			var Department = document.getElementById("userdepartment").value;
			var userDepartment = String(Department);
			var Profile = document.getElementById("userprofile").value;
			var userProfile = String(Profile);
			var Qualification = document.getElementById("userqualification").value;
			var userQualification = String(Qualification);
			var Location = document.getElementById("userlocation").value;
			var userLocation = String(Location);
			var modal = document.getElementById("myModal");

			$.ajax({
				type: "PUT",
				contentType: "application/json",
				url: "/updateUser",
				data: JSON.stringify({userId: userIdValue, userName: userName, userLocation: userLocation, userProfile: userProfile, userDepartment: userDepartment, userQualification: userQualification}),
				dataType: JSON,
				success: function (response) {
					console.log(response);
					var modalInstance = bootstrap.Modal.getInstance(modal);
					modalInstance.hide();
					window.location.href = "/home";
				},
				error: function (error) {
					var modalInstance = bootstrap.Modal.getInstance(modal);
					modalInstance.hide();
					console.log("the error is :: ", error);
					window.location.href = "/home";
				}
			})
		}


		//Clearing form inputs..
		var addTrigger = () => {
			console.log("inside the addtrigger...");
			var title = document.getElementById("card-title");
			title.innerText = "Add User Details."
			var submitBtn = document.getElementById("SubmitBtn");
			submitBtn.innerHTML = "Add User"
			var userId = document.getElementById("id-row");
			userId.classList.add("d-none");
			var userName = document.getElementById("username");
			userName.value = "";
			var userDepartment = document.getElementById("userdepartment");
			userDepartment.value = "";
			var userProfile = document.getElementById("userprofile");
			userProfile.value = "";
			var userQualification = document.getElementById("userqualification");
			userQualification.value = "";
			var userLocation = document.getElementById("userlocation");
			userLocation.value = "";
		}


		//common handler for submit btn.
		var commonHandler = () => {
			var button = document.getElementById("SubmitBtn");
			if (button.innerHTML == "Update User.") {
				console.log("inside the update", button.innerHTML);
				button.addEventListener('click', update);
			} else {
				console.log("inside the add", button.innerHTML);
				button.addEventListener('click', addUser);
			}
		}


		// Actual adding User to database.
		var addUser = () => {
			var Name = document.getElementById("username").value;
			userName = String(Name);
			var Department = document.getElementById("userdepartment").value;
			userDepartment = String(Department);
			var Profile = document.getElementById("userprofile").value;
			userProfile = String(Profile);
			var Qualification = document.getElementById("userqualification").value;
			userQualification = String(Qualification);
			var Location = document.getElementById("userlocation").value;
			userLocation = String(Location);
			var modal = document.getElementById("myModal");
			console.log("Sending data:", JSON.stringify({
				userName: userName,
				userDepartment: userDepartment,
				userProfile: userProfile,
				userQualification: userQualification,
				userLocation: userLocation
			}));

			$.ajax({
				type: "POST",
				contentType: "application/json",
				url: "/saveUser",
				data: JSON.stringify({userName: userName, userLocation: userLocation, userProfile: userProfile, userDepartment: userDepartment, userQualification: userQualification}),
				dataType: JSON,
				success: function (response) {
					console.log(response);
					var modalInstance = bootstrap.Modal.getInstance(modal);
					modalInstance.hide();
					window.location.href = "/home";
				},
				error: function (error) {
					var modalInstance = bootstrap.Modal.getInstance(modal);
					modalInstance.hide();
					console.log("the error is :: ", error);
					window.location.href = "/home";
				}
			})
		}
	</script>
</body>

</html>